AWSTemplateFormatVersion: "2010-09-09"
Parameters:
  AdminPassword:
    AllowedPattern: (?=^.{6,255}$)((?=.*\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*
    Default: P@ssw0rd
    Description: Password for the Admin account (Also used to create the trust) The default is "P@ssw0rd"
    MaxLength: '127'
    MinLength: '7'
    NoEcho: 'true'
    Type: String
  AMI:
    Default: /aws/service/ami-windows-latest/Windows_Server-2022-English-Full-Base
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
  MADDomainName:
    AllowedPattern: ^([a-zA-Z0-9]+[\\.-])+([a-zA-Z0-9])+$
    Default: corp.example.com
    Description: Fully qualified domain name (FQDN) of the AWS Managed Microsoft AD domain e.g. corp.example.com
    MaxLength: '255'
    MinLength: '2'
    Type: String
  MADNetBIOSName:
    AllowedPattern: ^[^\\/:*?"<>|.]+[^\\/:*?"<>|]*$
    Default: CORP
    Description: NetBIOS name of the AWS Managed Microsoft AD domain (up to 15 characters) e.g. CORP
    MaxLength: '15'
    MinLength: '1'
    Type: String
  OnpremDomainName:
    AllowedPattern: ^([a-zA-Z0-9]+[\\.-])+([a-zA-Z0-9])+$
    Default: onprem.local
    Description: Fully qualified domain name (FQDN) of the On-Premises domain e.g. onprem.local
    MaxLength: '255'
    MinLength: '2'
    Type: String
  OnpremNetBIOSName:
    AllowedPattern: ^[^\\/:*?"<>|.]+[^\\/:*?"<>|]*$
    Default: ONPREM
    Description: NetBIOS name of the On-Premises domain (up to 15 characters) e.g. ONPREM
    MaxLength: '15'
    MinLength: '1'
    Type: String
  RdpCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/x
    Default: 0.0.0.0/0
    Description: Allowed CIDR Block for external access to RDP into the instances
    Type: String    
  RDSPassword:
    AllowedPattern: (?=^.{6,255}$)((?=.*\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*
    Default: Passw0rd1
    Description: Password for the RDS Instance. The default is "Passw0rd1"
    MaxLength: '32'
    MinLength: '8'
    NoEcho: 'true'
    Type: String
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Configuration
        Parameters:
          - AdminPassword
          - AMI
          - MADDomainName
          - MADNetBIOSName
          - OnpremDomainName
          - OnpremNetBIOSName
          - RdpCIDR
          - RDSPassword
    ParameterLabels:
      AdminPassword:
        default: Admin & Trusts Password
      AMI:
        default: SSM Parameter Value for Latest AMI ID
      MADDomainName:
        default: AWS Managed Microsft AD Domain DNS Name
      MADNetBIOSName:
        default: AWS Managed Microsft AD Domain NetBIOS Name
      OnpremDomainName:
        default: On-Premises Domain DNS Name
      OnpremNetBIOSName:
        default: On-Premises Domain NetBIOS Name
      RdpCIDR:
        default: CIDR Block for Instance RDP Access
      RDSPassword:
        default: Amazon RDS SQL Instance Password
Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/24
      EnableDnsHostnames: true
      EnableDnsSupport: true
      InstanceTenancy: default
      Tags:
        - Key: Name
          Value: Demo-VPC
  VPCPublicSubnet1Subnet:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Select
        - 0
        - Fn::GetAZs: !Ref AWS::Region
      CidrBlock: !Select
        - 0
        - Fn::Cidr:
            - !GetAtt VPC.CidrBlock
            - 2
            - 6
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Demo-Subnet1
      VpcId: !Ref VPC
  VPCPublicSubnet1RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      Tags:
        - Key: Name
          Value: Demo-Subnet1
      VpcId: !Ref VPC
  VPCPublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: VPCPublicSubnet1RouteTable
      SubnetId:
        Ref: VPCPublicSubnet1Subnet
  VPCPublicSubnet1DefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCVPCGW
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: VPCIGW
      RouteTableId:
        Ref: VPCPublicSubnet1RouteTable
  VPCPublicSubnet2Subnet:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Select
        - 1
        - Fn::GetAZs: !Ref AWS::Region
      CidrBlock: !Select
        - 1
        - Fn::Cidr:
            - !GetAtt VPC.CidrBlock
            - 2
            - 6
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Demo-Subnet2
      VpcId: !Ref VPC
  VPCPublicSubnet2RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      Tags:
        - Key: Name
          Value: Demo-Subnet2
      VpcId: !Ref VPC
  VPCPublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: VPCPublicSubnet2RouteTable
      SubnetId:
        Ref: VPCPublicSubnet2Subnet
  VPCPublicSubnet2DefaultRoute:
    DependsOn: VPCVPCGW
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: VPCIGW
      RouteTableId:
        Ref: VPCPublicSubnet2RouteTable
  VPCIGW:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: Demo-IGW
  VPCVPCGW:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId:
        Ref: VPCIGW
      VpcId: !Ref VPC
  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - !Sub arn:${AWS::Partition}:iam::aws:policy/AmazonSSMManagedInstanceCore
        - !Sub arn:${AWS::Partition}:iam::aws:policy/CloudWatchAgentServerPolicy
      Path: /
      Policies:
        - PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action: cloudformation:SignalResource
                Effect: Allow
                Resource: !Sub arn:${AWS::Partition}:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${AWS::StackName}/*
              - Action: ssm:SendCommand
                Effect: Allow
                Resource:
                  - !Sub arn:${AWS::Partition}:ssm:${AWS::Region}:*:document/AWS-RunRemoteScript
                  - !Sub arn:${AWS::Partition}:ssm:${AWS::Region}:*:document/AWS-RunPowerShellScript
              - Action: ssm:SendCommand
                Condition:
                  StringEquals:
                    ssm:ResourceTag/aws:cloudformation:stack-name:
                      Ref: AWS::StackName
                Effect: Allow
                Resource: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/*
              - Action:
                  - ds:AddRegion
                  - ds:CreateConditionalForwarder
                  - ds:CreateLogSubscription
                  - ds:CreateMicrosoftAD
                  - ds:CreateTrust
                  - ds:DeleteConditionalForwarder
                  - ds:DeleteTrust
                  - ds:Describe*
                  - ds:Get*
                  - ds:List*
                  - ds:RegisterEventTopic
                  - ds:RejectSharedDirectory
                  - ds:RemoveRegion
                  - ds:ShareDirectory
                  - ds:UnshareDirectory
                  - ds:UpdateConditionalForwarder
                  - ds:UpdateTrust
                  - ds:VerifyTrust
                  - ec2:AuthorizeSecurityGroupEgress
                  - ec2:AuthorizeSecurityGroupIngress
                  - ec2:CreateNetworkInterface
                  - ec2:CreateSecurityGroup
                  - ec2:DeleteNetworkInterface
                  - ec2:DeleteSecurityGroup
                  - ec2:DescribeInstances
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DescribeSubnets
                  - ec2:DescribeVpcs
                  - ec2:RevokeSecurityGroupEgress
                  - ec2:RevokeSecurityGroupIngress
                  - ec2:DescribeSecurityGroups
                  - logs:CreateLogGroup
                  - logs:GetLogEvents
                  - logs:PutResourcePolicy
                  - sns:GetTopicAttributes
                  - sns:ListSubscriptions
                  - sns:ListSubscriptionsByTopic
                  - sns:ListTopics
                  - ssm:DescribeInstanceInformation
                  - ssm:ListCommands
                  - ssm:ListCommandInvocations
                  - ssm:StartAutomationExecution
                  - sts:GetCallerIdentity
                Effect: Allow
                Resource: "*"
          PolicyName: Inline-Policy
      Tags:
        - Key: StackName
          Value:
            Ref: AWS::StackName
  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - Ref: InstanceRole
  RDSRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - rds.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AmazonRDSDirectoryServiceAccess
      Path: /
      Tags:
        - Key: StackName
          Value:
            Ref: AWS::StackName
  ManagedAD:
    Type: AWS::DirectoryService::MicrosoftAD
    Properties:
      CreateAlias: false
      Edition: Enterprise
      EnableSso: false
      Name: !Ref MADDomainName
      Password: !Ref AdminPassword
      ShortName: !Ref MADNetBIOSName
      VpcSettings:
        SubnetIds:
          - !Ref VPCPublicSubnet1Subnet
          - !Ref VPCPublicSubnet2Subnet
        VpcId: !Ref VPC
  DomainMemberSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: MAD Domain Members and RDS SG
      SecurityGroupIngress:
        - Description: All Local VPC Traffic
          FromPort: -1
          IpProtocol: "-1"
          CidrIp: 10.0.0.0/24
          ToPort: -1
        - Description: RDP Access
          FromPort: 3389
          IpProtocol: tcp
          CidrIp: !Ref RdpCIDR
          ToPort: 3389
        - Description: SQL Access
          FromPort: 1433
          IpProtocol: tcp
          CidrIp: 10.0.0.0/24
          ToPort: 1433
      Tags:
        - Key: Name
          Value: DomainMembersSecurityGroup
      VpcId: !Ref VPC
  MgmtInstanceSSMAuto:
    Type: AWS::SSM::Document
    Properties:
      DocumentType: Automation
      Content:
        schemaVersion: "0.3"
        description: Deploy AD with SSM Automation
        parameters:
          AdminPassword:
            description: Password for the Admin account (Also used to create the trust)
            type: String
          DomainDNSName:
            description: Fully qualified domain name (FQDN) of the forest root domain e.g. example.com
            type: String
          DomainNetBIOSName:
            description: NetBIOS name of the domain (up to 15 characters) for users of earlier versions of Windows e.g. EXAMPLE
            type: String
          ExistingDcIP01:
            description: IP of DNS server that can resolve domain (Must be accessible)
            type: String
          ExistingDcIP02:
            description: IP of DNS server that can resolve domain (Must be accessible)
            type: String
          MgmtServerNetBIOSName:
            description: NetBIOS name of the Management Instance server (up to 15 characters)
            type: String
          StackName:
            description: Stack Name Input for cfn resource signal
            type: String
          URLSuffix:
            description: AWS URL suffix
            type: String
          VPCCIDR:
            description: CIDR Block for the VPC
            type: String
        mainSteps:
          - name: mgmtInstanceId
            action: aws:executeAwsApi
            onFailure: step:signalfailure
            inputs:
              Service: ec2
              Api: DescribeInstances
              Filters:
                - Name: tag:Name
                  Values: ["{{MgmtServerNetBIOSName}}"]
                - Name: tag:aws:cloudformation:stack-name
                  Values: ["{{StackName}}"]
                - Name: instance-state-name
                  Values: ["running"]
            outputs:
              - Name: InstanceId
                Selector: $.Reservations[0].Instances[0].InstanceId
                Type: String
            nextStep: intializeInstance
          - name: intializeInstance
            action: aws:runCommand
            inputs:
              DocumentName: AWS-RunPowerShellScript
              InstanceIds:
                - "{{mgmtInstanceId.InstanceId}}"
              Parameters:
                commands: |-
                  [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

                  $Modules = @(
                      @{
                          Name = 'NetworkingDsc'
                          Version = '8.2.0'
                      },
                      @{
                          Name = 'ActiveDirectoryDsc'
                          Version = '6.0.1'
                      },
                      @{
                          Name = 'ComputerManagementDsc'
                          Version = '8.4.0'
                      },
                      @{
                          Name = 'DnsServerDsc'
                          Version = '3.0.0'
                      }
                  )

                  Write-Output 'Creating AWSQuickstart Directory'
                  Try {
                      $Null = New-Item -Path 'C:\AWSQuickstart\Module-AD' -ItemType 'Directory' -ErrorAction Stop
                  } Catch [System.Exception] {
                      Write-Output "Failed to create AWSQuickstart directory $_"
                      Exit 1
                  }

                  Write-Output 'Installing NuGet Package Provider'
                  Try {
                      $Null = Install-PackageProvider -Name 'NuGet' -MinimumVersion '2.8.5' -Force -ErrorAction Stop
                  } Catch [System.Exception] {
                      Write-Output "Failed to install NuGet Package Provider $_"
                      Exit 1
                  }

                  Write-Output 'Setting PSGallery Respository to trusted'
                  Try {
                      Set-PSRepository -Name 'PSGallery' -InstallationPolicy 'Trusted' -ErrorAction Stop
                  } Catch [System.Exception] {
                      Write-Output "Failed to set PSGallery Respository to trusted $_"
                      Exit 1
                  }

                  Write-Output 'Installing the needed Powershell DSC modules for this Quick Start'
                  Foreach ($Module in $Modules) {
                      Try {
                          Install-Module -Name $Module.Name -RequiredVersion $Module.Version -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to Import Modules $_"
                          Exit 1
                      }
                  }

                  Write-Output 'Installing SQL Server Management Studio'
                  (New-Object -TypeName 'System.Net.WebClient').DownloadFile('https://aka.ms/ssmsfullsetup', 'C:\AWSQuickstart\SSMS-Setup.exe')
                  $ArgumentList = '/Quiet'
                  Try {
                      $Process = Start-Process -FilePath 'C:\AWSQuickstart\SSMS-Setup.exe' -ArgumentList $ArgumentList -NoNewWindow -Wait -ErrorAction Stop
                  } Catch [System.Exception] {
                      Write-Output "Failed to install SQL Server Management Studio $_"
                      #Exit 1
                  }

              CloudWatchOutputConfig:
                CloudWatchOutputEnabled: true
                CloudWatchLogGroupName: !Sub /aws/Quick_Start/${AWS::StackName}
            nextStep: configureInstance
          - name: configureInstance
            action: aws:runCommand
            inputs:
              DocumentName: AWS-RunPowerShellScript
              InstanceIds:
                - "{{mgmtInstanceId.InstanceId}}"
              Parameters:
                commands: |-
                  Function New-VolumeFromRawDisk {
                      Write-Output 'Finding RAW Disk'
                      $Counter = 0
                      Do {
                          Try {
                              $BlankDisks = Get-Disk -ErrorAction Stop | Where-Object { $_.PartitionStyle -eq 'RAW' } | Select-Object -ExpandProperty 'Number'
                          } Catch [System.Exception] {
                              Write-Output "Failed to get disk $_"
                              $BlankDisks = $Null
                          }    
                          If (-not $BlankDisks) {
                              $Counter ++
                              Write-Output 'RAW Disk not found sleeping 10 seconds and will try again.'
                              Start-Sleep -Seconds 10
                          }
                      } Until ($BlankDisks -or $Counter -eq 12)

                      If ($Counter -ge 12) {
                          Write-Output 'RAW Disk not found exiting'
                          Return
                      }

                      Foreach ($BlankDisk in $BlankDisks) {
                          Write-Output 'Data Volume not initialized attempting to bring online'
                          Try {
                              Initialize-Disk -Number $BlankDisk -PartitionStyle 'GPT' -ErrorAction Stop
                          } Catch [System.Exception] {
                              Write-Output "Failed attempting to bring online Data Volume $_"
                              Exit 1
                          }

                          Start-Sleep -Seconds 5

                          Write-Output 'Data Volume creating new partition'
                          Try {
                              $DriveLetter = New-Partition -DiskNumber $BlankDisk -AssignDriveLetter -UseMaximumSize -ErrorAction Stop | Select-Object -ExpandProperty 'DriveLetter'
                          } Catch [System.Exception] {
                              Write-Output "Failed creating new partition $_"
                              Exit 1
                          }

                          Start-Sleep -Seconds 5

                          Write-Output 'Data Volume formatting partition'
                          Try {
                              $Null = Format-Volume -DriveLetter $DriveLetter -FileSystem 'NTFS' -NewFileSystemLabel 'Data' -Confirm:$false -Force -ErrorAction Stop
                          } Catch [System.Exception] {
                              Write-Output "Failed formatting partition $_"
                              Exit 1
                          }

                          Try {
                              $Null = Get-CimInstance -ClassName 'Win32_Volume' -Filter "DriveLetter='$($DriveLetter):'" -ErrorAction Stop | Set-CimInstance -Arguments @{ IndexingEnabled = $False }
                          } Catch [System.Exception] {
                              Write-Output "Failed to turn off indexing $_"
                              Exit 1
                          }
                      }
                  }

                  Function Invoke-PreConfig {
                      Write-Output 'Temporarily disabling Windows Firewall'
                      Try {
                          Get-NetFirewallProfile -ErrorAction Stop | Set-NetFirewallProfile -Enabled False -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to disable Windows Firewall $_"
                          Exit 1
                      }
                      
                      Write-Output 'Creating file directory for DSC public cert'
                      Try {
                          $Null = New-Item -Path 'C:\AWSQuickstart\publickeys' -ItemType 'Directory' -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to create publickeys file directory $_"
                          Exit 1
                      }
                      
                      Write-Output 'Creating certificate to encrypt credentials in MOF file'
                      Try {
                          $cert = New-SelfSignedCertificate -Type 'DocumentEncryptionCertLegacyCsp' -DnsName 'AWSQSDscEncryptCert' -HashAlgorithm 'SHA256' -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to create self signed cert $_"
                          Exit 1
                      }
                      
                      Write-Output 'Exporting the self signed public key certificate'
                      Try {
                          $Null = $cert | Export-Certificate -FilePath 'C:\AWSQuickstart\publickeys\AWSQSDscPublicKey.cer' -Force -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to copy self signed cert to publickeys directory $_"
                          Exit 1
                      }    
                  }

                  Function Invoke-LcmConfig {
                      Write-Output 'Getting the DSC cert thumbprint to secure the MOF file'
                      Try {
                          $DscCertThumbprint = Get-ChildItem -Path 'cert:\LocalMachine\My' -ErrorAction Stop | Where-Object { $_.Subject -eq 'CN=AWSQSDscEncryptCert' } | Select-Object -ExpandProperty 'Thumbprint'
                      } Catch [System.Exception] {
                          Write-Output "Failed to get DSC cert thumbprint $_"
                          Exit 1
                      } 
                      
                      [DSCLocalConfigurationManager()]
                      Configuration LCMConfig
                      {
                          Node 'localhost' {
                              Settings {
                                  RefreshMode                    = 'Push'
                                  ConfigurationModeFrequencyMins = 15
                                  ActionAfterReboot              = 'StopConfiguration'                      
                                  RebootNodeIfNeeded             = $false
                                  ConfigurationMode              = 'ApplyAndAutoCorrect'
                                  CertificateId                  = $DscCertThumbprint  
                              }
                          }
                      }
                      
                      Write-Output 'Generating MOF file for LCM'
                      LCMConfig -OutputPath 'C:\AWSQuickstart\LCMConfig'
                          
                      Write-Output 'Sets LCM configuration to MOF generated in previous command'
                      Try {
                          Set-DscLocalConfigurationManager -Path 'C:\AWSQuickstart\LCMConfig' -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to set LCM configuration $_"
                          Exit 1
                      } 
                  }

                  Function Get-EniConfig {
                      Write-Output 'Getting network configuration'
                      Try {
                          $NetIpConfig = Get-NetIPConfiguration -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to get network configuration $_"
                          Exit 1
                      }

                      Write-Output 'Grabbing the current gateway address in order to static IP correctly'
                      $GatewayAddress = $NetIpConfig | Select-Object -ExpandProperty 'IPv4DefaultGateway' | Select-Object -ExpandProperty 'NextHop'

                      Write-Output 'Formatting IP address in format needed for IPAdress DSC resource'
                      $IpAddress = $NetIpConfig | Select-Object -ExpandProperty 'IPv4Address' | Select-Object -ExpandProperty 'IpAddress'
                      $Prefix = $NetIpConfig | Select-Object -ExpandProperty 'IPv4Address' | Select-Object -ExpandProperty 'PrefixLength'
                      $IpAddr = 'IP/CIDR' -replace 'IP', $IpAddress -replace 'CIDR', $Prefix

                      Write-Output 'Getting MAC address'
                      Try {
                          $MacAddress = Get-NetAdapter -ErrorAction Stop | Select-Object -ExpandProperty 'MacAddress'
                      } Catch [System.Exception] {
                          Write-Output "Failed to get MAC address $_"
                          Exit 1
                      }

                      $Output = [PSCustomObject][Ordered]@{
                          'GatewayAddress' = $GatewayAddress
                          'IpAddress'      = $IpAddr
                          'DnsIpAddress'   = $IpAddress
                          'MacAddress'     = $MacAddress
                      }
                      Return $Output
                  }

                  Function Set-DscConfiguration {
                      [CmdletBinding()]
                      param(
                          [Parameter(Mandatory = $true)][PSCredential]$DaCredentials,
                          [Parameter(Mandatory = $true)][string]$DomainDNSName,
                          [Parameter(Mandatory = $true)][string]$DomainNetBIOSName,
                          [Parameter(Mandatory = $false)][string]$ExistingDcIP01,
                          [Parameter(Mandatory = $false)][string]$ExistingDcIP02,
                          [Parameter(Mandatory = $true)][string]$GatewayAddress,
                          [Parameter(Mandatory = $true)][string]$InstanceIP,
                          [Parameter(Mandatory = $true)][string]$InstanceNetBIOSName,
                          [Parameter(Mandatory = $true)][string]$MacAddress
                      )

                      $VPCDNS = '169.254.169.253'

                      Write-Output 'Getting the DSC encryption thumbprint to secure the MOF file'
                      Try {
                          $DscCertThumbprint = Get-ChildItem -Path 'cert:\LocalMachine\My' -ErrorAction Stop | Where-Object { $_.Subject -eq 'CN=AWSQSDscEncryptCert' } | Select-Object -ExpandProperty 'Thumbprint'
                      } Catch [System.Exception] {
                          Write-Output "Failed to get DSC cert thumbprint $_"
                          Exit 1
                      }
                      
                      Write-Output 'Creating configuration data block that has the certificate information for DSC configuration processing'
                      $ConfigurationData = @{
                          AllNodes = @(
                              @{
                                  NodeName             = '*'
                                  CertificateFile      = 'C:\AWSQuickstart\publickeys\AWSQSDscPublicKey.cer'
                                  Thumbprint           = $DscCertThumbprint
                                  PSDscAllowDomainUser = $true
                              },
                              @{
                                  NodeName = 'localhost'
                              }
                          )
                      }
                      
                      Configuration ConfigInstance {
                          Import-DscResource -ModuleName 'PSDesiredStateConfiguration', 'NetworkingDsc', 'ComputerManagementDsc', 'DnsServerDsc', 'ActiveDirectoryDsc'
                          Node LocalHost {
                              NetAdapterName RenameNetAdapterPrimary {
                                  NewName    = 'Primary'
                                  MacAddress = $MacAddress
                              }
                              NetIPInterface DisableDhcp {
                                  Dhcp           = 'Disabled'
                                  InterfaceAlias = 'Primary'
                                  AddressFamily  = 'IPv4'
                                  DependsOn      = '[NetAdapterName]RenameNetAdapterPrimary'
                              }
                              IPAddress SetIP {
                                  IPAddress      = $InstanceIP
                                  InterfaceAlias = 'Primary'
                                  AddressFamily  = 'IPv4'
                                  DependsOn      = '[NetIPInterface]DisableDhcp'
                              }
                              DefaultGatewayAddress SetDefaultGateway {
                                  Address        = $GatewayAddress
                                  InterfaceAlias = 'Primary'
                                  AddressFamily  = 'IPv4'
                                  DependsOn      = '[IPAddress]SetIP'
                              }
                              DnsServerAddress DnsServerAddress {
                                  Address        = $ExistingDcIP01, $ExistingDcIP02, '169.254.169.253'
                                  InterfaceAlias = 'Primary'
                                  AddressFamily  = 'IPv4'
                                  DependsOn      = '[DefaultGatewayAddress]SetDefaultGateway'
                              }
                              DnsConnectionSuffix DnsConnectionSuffix {
                                  InterfaceAlias                 = 'Primary'
                                  ConnectionSpecificSuffix       = $DomainDNSName
                                  RegisterThisConnectionsAddress = $True
                                  UseSuffixWhenRegistering       = $False
                                  DependsOn                      = '[DnsServerAddress]DnsServerAddress'
                              }
                              WindowsFeature DnsTools {
                                  Ensure    = 'Present'
                                  Name      = 'RSAT-DNS-Server'
                                  DependsOn = '[DnsConnectionSuffix]DnsConnectionSuffix'
                              }
                              WindowsFeature RSAT-AD-Tools {
                                  Ensure    = 'Present'
                                  Name      = 'RSAT-AD-Tools'
                                  DependsOn = '[WindowsFeature]DnsTools'
                              }
                              WindowsFeature RSAT-ADDS {
                                  Ensure    = 'Present'
                                  Name      = 'RSAT-ADDS'
                                  DependsOn = '[WindowsFeature]RSAT-AD-Tools'
                              }
                              WindowsFeature GPMC {
                                  Ensure    = 'Present'
                                  Name      = 'GPMC'
                                  DependsOn = '[WindowsFeature]RSAT-ADDS'
                              }
                              Computer JoinDomain {
                                  Name       = $InstanceNetBIOSName
                                  DomainName = $DomainDnsName
                                  Credential = $DaCredentials
                                  DependsOn  = '[WindowsFeature]GPMC'
                              }
                          }
                      }
                      Write-Output 'Generating MOF file'
                      ConfigInstance -OutputPath 'C:\AWSQuickstart\ConfigInstance' -ConfigurationData $ConfigurationData
                  }

                  $UserPassword = ConvertTo-SecureString '{{AdminPassword}}' -AsPlainText -Force
                  $AltAdminCredentials = New-Object -TypeName 'System.Management.Automation.PSCredential' ('{{DomainDNSName}}\Admin', $UserPassword)
                  New-VolumeFromRawDisk
                  Invoke-PreConfig
                  Invoke-LcmConfig
                  $EniConfig = Get-EniConfig
                  Set-DscConfiguration -DaCredentials $AltAdminCredentials -DomainDNSName '{{DomainDNSName}}' -DomainNetBIOSName '{{DomainNetBIOSName}}' -ExistingDcIP01 '{{ExistingDcIP01}}' -ExistingDcIP02 '{{ExistingDcIP02}}' -GatewayAddress $EniConfig.GatewayAddress -InstanceIP $EniConfig.IpAddress -InstanceNetBIOSName '{{MgmtServerNetBIOSName}}' -MacAddress $EniConfig.MacAddress
            nextStep: runMgmtMof
          - name: runMgmtMof
            action: aws:runCommand
            onFailure: step:signalfailure
            inputs:
              DocumentName: AWS-RunPowerShellScript
              InstanceIds:
                - "{{mgmtInstanceId.InstanceId}}"
              Parameters:
                commands: |-
                  Function Invoke-DscStatusCheck {
                      $LCMState = Get-DscLocalConfigurationManager -ErrorAction SilentlyContinue | Select-Object -ExpandProperty 'LCMState'
                      If ($LCMState -eq 'PendingConfiguration' -Or $LCMState -eq 'PendingReboot') {
                          Exit 3010
                      } Else {
                          Write-Output 'DSC Config Completed'
                      }
                  }

                  Start-DscConfiguration 'C:\AWSQuickstart\ConfigInstance' -Wait -Verbose -Force
                  Invoke-DscStatusCheck
              CloudWatchOutputConfig:
                CloudWatchOutputEnabled: true
                CloudWatchLogGroupName: !Sub /aws/Quick_Start/${AWS::StackName}
            nextStep: PostConfig
          - name: PostConfig
            action: aws:runCommand
            inputs:
              DocumentName: AWS-RunPowerShellScript
              InstanceIds:
                - "{{mgmtInstanceId.InstanceId}}"
              Parameters:
                commands: |-
                  Function Invoke-Cleanup {
                      [CmdletBinding()]
                      Param (
                          [Parameter(Mandatory = $true)][String]$VPCCIDR
                      )

                      #==================================================
                      # Main
                      #==================================================

                      Write-Output 'Setting Windows Firewall WinRM Public rule to allow VPC CIDR traffic'
                      Try {
                          Set-NetFirewallRule -Name 'WINRM-HTTP-In-TCP-PUBLIC' -RemoteAddress $VPCCIDR
                      } Catch [System.Exception] {
                          Write-Output "Failed allow WinRM Traffic from VPC CIDR $_"
                      }

                      Write-Output 'Removing DSC Configuration'
                      Try {    
                          Remove-DscConfigurationDocument -Stage 'Current' -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed build DSC Configuration $_"
                      }

                      Write-Output 'Re-enabling Windows Firewall'
                      Try {
                          Get-NetFirewallProfile -ErrorAction Stop | Set-NetFirewallProfile -Enabled 'True' -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed re-enable firewall $_"
                      }

                      Write-Output 'Removing QuickStart build files'
                      Try {
                          Remove-Item -Path 'C:\AWSQuickstart' -Recurse -Force -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed remove QuickStart build files $_"
                      }

                      Write-Output 'Removing self signed cert'
                      Try {
                          $SelfSignedThumb = Get-ChildItem -Path 'cert:\LocalMachine\My\' -ErrorAction Stop | Where-Object { $_.Subject -eq 'CN=AWSQSDscEncryptCert' } | Select-Object -ExpandProperty 'Thumbprint'
                          Remove-Item -Path "cert:\LocalMachine\My\$SelfSignedThumb" -DeleteKey -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed remove self signed cert $_"
                      }
                  }

                  Invoke-Cleanup -VPCCIDR '{{VPCCIDR}}'
              CloudWatchOutputConfig:
                CloudWatchOutputEnabled: true
                CloudWatchLogGroupName: !Sub /aws/Quick_Start/${AWS::StackName}
          - name: CFNSignalEnd
            action: aws:branch
            inputs:
              Choices:
                - NextStep: signalsuccess
                  Not:
                    Variable: "{{StackName}}"
                    StringEquals: ""
                - NextStep: sleepend
                  Variable: "{{StackName}}"
                  StringEquals: ""
          - name: signalsuccess
            action: aws:executeAwsApi
            isEnd: True
            inputs:
              Service: cloudformation
              Api: SignalResource
              LogicalResourceId: MgmtInstance
              StackName: "{{StackName}}"
              Status: SUCCESS
              UniqueId: "{{mgmtInstanceId.InstanceId}}"
          - name: sleepend
            action: aws:sleep
            isEnd: True
            inputs:
              Duration: PT1S
          - name: signalfailure
            action: aws:executeAwsApi
            inputs:
              Service: cloudformation
              Api: SignalResource
              LogicalResourceId: MgmtInstance
              StackName: "{{StackName}}"
              Status: FAILURE
              UniqueId: "{{mgmtInstanceId.InstanceId}}"
      Tags:
        - Key: StackName
          Value: !Ref AWS::StackName
  MgmtInstance:
    Type: AWS::EC2::Instance
    CreationPolicy:
      ResourceSignal:
        Timeout: PT30M
        Count: 1
    DependsOn: ManagedAD
    Properties:
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 60
            VolumeType: gp3
            Encrypted: true
            KmsKeyId: alias/aws/ebs
            DeleteOnTermination: true
        - DeviceName: /dev/xvdf
          Ebs:
            VolumeSize: 10
            VolumeType: gp3
            Encrypted: true
            KmsKeyId: alias/aws/ebs
            DeleteOnTermination: true
      IamInstanceProfile: !Ref InstanceProfile
      ImageId: !Ref AMI
      InstanceType: t3.large
      KeyName: ee-default-keypair
      SecurityGroupIds:
        - !Ref DomainMemberSG
      SubnetId: !Ref VPCPublicSubnet1Subnet
      Tags:
        - Key: Name
          Value: MAD-MGMT01
        - Key: Domain
          Value: !Ref MADDomainName
      UserData:
        Fn::Base64:
          Fn::Sub:
            - |
              <powershell>
              $Params = @{
                  AdminPassword         = '${AdminPassword}'
                  DomainDNSName         = '${DomainDNSName}'
                  DomainNetBIOSName     = '${DomainNetBIOSName}'
                  ExistingDcIP01        = '${ExistingDcIP01}'
                  ExistingDcIP02        = '${ExistingDcIP02}'
                  MgmtServerNetBIOSName = 'MAD-MGMT01'
                  StackName             = '${AWS::StackName}'
                  URLSuffix             = '${AWS::URLSuffix}'
                  VPCCIDR               = '${VPCCIDR}'
              }
              Start-SSMAutomationExecution -DocumentName '${MgmtInstanceSSMAuto}' -Parameter $Params
              </powershell>
            - AdminPassword: !Ref AdminPassword
              DomainDNSName: !Ref MADDomainName
              DomainNetBIOSName: !Ref MADNetBIOSName
              ExistingDcIP01: !Select [0, !GetAtt ManagedAD.DnsIpAddresses]
              ExistingDcIP02: !Select [1, !GetAtt ManagedAD.DnsIpAddresses]
              VPCCIDR: !GetAtt VPC.CidrBlock
  OnPremDomainControllerSsmAuto:
    Type: AWS::SSM::Document
    Properties:
      Content:
        schemaVersion: "0.3"
        description: Deploy AD with SSM Automation
        parameters:
          ADServer1NetBIOSName:
            description: NetBIOS name of the first Active Directory Domain Controller (up to 15 characters)
            type: String
          DomainDNSName:
            description: Fully qualified domain name (FQDN) of the forest root domain e.g. onprem.local
            type: String
          DomainNetBIOSName:
            description: NetBIOS name of the domain (up to 15 characters) for users of earlier versions of Windows e.g. EXAMPLE
            type: String
          MadDcIP01:
            description: IP Address of MAD domain controller
            type: String
          MadDcIP02:
            description: IP Address of MAD domain controller
            type: String
          MadDirectoryID:
            description: Directory ID of MAD domain
            type: String
          MadDNSName:
            description: Fully qualified domain name (FQDN) of the MAD domain e.g. corp.example.com
            type: String
          AdminPassword:
            description: Password for the Admin account (Also used to create the trust)
            type: String
          StackName:
            description: Stack Name Input for cfn resource signal
            type: String
          URLSuffix:
            description: AWS URL suffix
            type: String
          VPCCIDR:
            description: CIDR Block for the VPC
            type: String
        mainSteps:
          - name: dc1InstanceId
            action: aws:executeAwsApi
            onFailure: step:signalfailure
            inputs:
              Service: ec2
              Api: DescribeInstances
              Filters:
                - Name: tag:Name
                  Values:
                    - "{{ADServer1NetBIOSName}}"
                - Name: tag:aws:cloudformation:stack-name
                  Values:
                    - "{{StackName}}"
                - Name: instance-state-name
                  Values:
                    - running
            outputs:
              - Name: InstanceId
                Selector: $.Reservations[0].Instances[0].InstanceId
                Type: String
            nextStep: intializeInstance
          - name: intializeInstance
            action: aws:runCommand
            inputs:
              DocumentName: AWS-RunPowerShellScript
              InstanceIds:
                - "{{dc1InstanceId.InstanceId}}"
              Parameters:
                commands: |-
                  [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

                  $Modules = @(
                      @{
                          Name = 'NetworkingDsc'
                          Version = '8.2.0'
                      },
                      @{
                          Name = 'ActiveDirectoryDsc'
                          Version = '6.0.1'
                      },
                      @{
                          Name = 'ComputerManagementDsc'
                          Version = '8.4.0'
                      },
                      @{
                          Name = 'DnsServerDsc'
                          Version = '3.0.0'
                      }
                  )

                  Write-Output 'Creating AWSQuickstart Directory'
                  Try {
                      $Null = New-Item -Path 'C:\AWSQuickstart\Module-AD' -ItemType 'Directory' -ErrorAction Stop
                  } Catch [System.Exception] {
                      Write-Output "Failed to create AWSQuickstart directory $_"
                      Exit 1
                  }

                  Write-Output 'Installing NuGet Package Provider'
                  Try {
                      $Null = Install-PackageProvider -Name 'NuGet' -MinimumVersion '2.8.5' -Force -ErrorAction Stop
                  } Catch [System.Exception] {
                      Write-Output "Failed to install NuGet Package Provider $_"
                      Exit 1
                  }

                  Write-Output 'Setting PSGallery Respository to trusted'
                  Try {
                      Set-PSRepository -Name 'PSGallery' -InstallationPolicy 'Trusted' -ErrorAction Stop
                  } Catch [System.Exception] {
                      Write-Output "Failed to set PSGallery Respository to trusted $_"
                      Exit 1
                  }

                  Write-Output 'Installing the needed Powershell DSC modules for this Quick Start'
                  Foreach ($Module in $Modules) {
                      Try {
                          Install-Module -Name $Module.Name -RequiredVersion $Module.Version -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to Import Modules $_"
                          Exit 1
                      }
                  }
              CloudWatchOutputConfig:
                CloudWatchOutputEnabled: true
                CloudWatchLogGroupName: !Sub /aws/Quick_Start/${AWS::StackName}
            nextStep: configureInstance
          - name: configureInstance
            action: aws:runCommand
            inputs:
              DocumentName: AWS-RunPowerShellScript
              InstanceIds:
                - "{{dc1InstanceId.InstanceId}}"
              Parameters:
                commands: |-
                  Function New-VolumeFromRawDisk {
                      Write-Output 'Finding RAW Disk'
                      $Counter = 0
                      Do {
                          Try {
                              $BlankDisks = Get-Disk -ErrorAction Stop | Where-Object { $_.PartitionStyle -eq 'RAW' } | Select-Object -ExpandProperty 'Number'
                          } Catch [System.Exception] {
                              Write-Output "Failed to get disk $_"
                              $BlankDisks = $Null
                          }    
                          If (-not $BlankDisks) {
                              $Counter ++
                              Write-Output 'RAW Disk not found sleeping 10 seconds and will try again.'
                              Start-Sleep -Seconds 10
                          }
                      } Until ($BlankDisks -or $Counter -eq 12)

                      If ($Counter -ge 12) {
                          Write-Output 'RAW Disk not found exiting'
                          Return
                      }

                      Foreach ($BlankDisk in $BlankDisks) {
                          Write-Output 'Data Volume not initialized attempting to bring online'
                          Try {
                              Initialize-Disk -Number $BlankDisk -PartitionStyle 'GPT' -ErrorAction Stop
                          } Catch [System.Exception] {
                              Write-Output "Failed attempting to bring online Data Volume $_"
                              Exit 1
                          }

                          Start-Sleep -Seconds 5

                          Write-Output 'Data Volume creating new partition'
                          Try {
                              $DriveLetter = New-Partition -DiskNumber $BlankDisk -AssignDriveLetter -UseMaximumSize -ErrorAction Stop | Select-Object -ExpandProperty 'DriveLetter'
                          } Catch [System.Exception] {
                              Write-Output "Failed creating new partition $_"
                              Exit 1
                          }

                          Start-Sleep -Seconds 5

                          Write-Output 'Data Volume formatting partition'
                          Try {
                              $Null = Format-Volume -DriveLetter $DriveLetter -FileSystem 'NTFS' -NewFileSystemLabel 'Data' -Confirm:$false -Force -ErrorAction Stop
                          } Catch [System.Exception] {
                              Write-Output "Failed formatting partition $_"
                              Exit 1
                          }

                          Try {
                              $Null = Get-CimInstance -ClassName 'Win32_Volume' -Filter "DriveLetter='$($DriveLetter):'" -ErrorAction Stop | Set-CimInstance -Arguments @{ IndexingEnabled = $False }
                          } Catch [System.Exception] {
                              Write-Output "Failed to turn off indexing $_"
                              Exit 1
                          }
                      }
                  }

                  Function Invoke-PreConfig {
                      Write-Output 'Temporarily disabling Windows Firewall'
                      Try {
                          Get-NetFirewallProfile -ErrorAction Stop | Set-NetFirewallProfile -Enabled False -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to disable Windows Firewall $_"
                          Exit 1
                      }
                      
                      Write-Output 'Creating file directory for DSC public cert'
                      Try {
                          $Null = New-Item -Path 'C:\AWSQuickstart\publickeys' -ItemType 'Directory' -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to create publickeys file directory $_"
                          Exit 1
                      }
                      
                      Write-Output 'Creating certificate to encrypt credentials in MOF file'
                      Try {
                          $cert = New-SelfSignedCertificate -Type 'DocumentEncryptionCertLegacyCsp' -DnsName 'AWSQSDscEncryptCert' -HashAlgorithm 'SHA256' -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to create self signed cert $_"
                          Exit 1
                      }
                      
                      Write-Output 'Exporting the self signed public key certificate'
                      Try {
                          $Null = $cert | Export-Certificate -FilePath 'C:\AWSQuickstart\publickeys\AWSQSDscPublicKey.cer' -Force -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to copy self signed cert to publickeys directory $_"
                          Exit 1
                      }    
                  }

                  Function Invoke-LcmConfig {
                      Write-Output 'Getting the DSC cert thumbprint to secure the MOF file'
                      Try {
                          $DscCertThumbprint = Get-ChildItem -Path 'cert:\LocalMachine\My' -ErrorAction Stop | Where-Object { $_.Subject -eq 'CN=AWSQSDscEncryptCert' } | Select-Object -ExpandProperty 'Thumbprint'
                      } Catch [System.Exception] {
                          Write-Output "Failed to get DSC cert thumbprint $_"
                          Exit 1
                      } 
                      
                      [DSCLocalConfigurationManager()]
                      Configuration LCMConfig
                      {
                          Node 'localhost' {
                              Settings {
                                  RefreshMode                    = 'Push'
                                  ConfigurationModeFrequencyMins = 15
                                  ActionAfterReboot              = 'StopConfiguration'                      
                                  RebootNodeIfNeeded             = $false
                                  ConfigurationMode              = 'ApplyAndAutoCorrect'
                                  CertificateId                  = $DscCertThumbprint  
                              }
                          }
                      }
                      
                      Write-Output 'Generating MOF file for LCM'
                      LCMConfig -OutputPath 'C:\AWSQuickstart\LCMConfig'
                          
                      Write-Output 'Sets LCM configuration to MOF generated in previous command'
                      Try {
                          Set-DscLocalConfigurationManager -Path 'C:\AWSQuickstart\LCMConfig' -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to set LCM configuration $_"
                          Exit 1
                      } 
                  }

                  Function Get-EniConfig {
                      Write-Output 'Getting network configuration'
                      Try {
                          $NetIpConfig = Get-NetIPConfiguration -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to get network configuration $_"
                          Exit 1
                      }

                      Write-Output 'Grabbing the current gateway address in order to static IP correctly'
                      $GatewayAddress = $NetIpConfig | Select-Object -ExpandProperty 'IPv4DefaultGateway' | Select-Object -ExpandProperty 'NextHop'

                      Write-Output 'Formatting IP address in format needed for IPAdress DSC resource'
                      $IpAddress = $NetIpConfig | Select-Object -ExpandProperty 'IPv4Address' | Select-Object -ExpandProperty 'IpAddress'
                      $Prefix = $NetIpConfig | Select-Object -ExpandProperty 'IPv4Address' | Select-Object -ExpandProperty 'PrefixLength'
                      $IpAddr = 'IP/CIDR' -replace 'IP', $IpAddress -replace 'CIDR', $Prefix

                      Write-Output 'Getting MAC address'
                      Try {
                          $MacAddress = Get-NetAdapter -ErrorAction Stop | Select-Object -ExpandProperty 'MacAddress'
                      } Catch [System.Exception] {
                          Write-Output "Failed to get MAC address $_"
                          Exit 1
                      }

                      $Output = [PSCustomObject][Ordered]@{
                          'GatewayAddress' = $GatewayAddress
                          'IpAddress'      = $IpAddr
                          'DnsIpAddress'   = $IpAddress
                          'MacAddress'     = $MacAddress
                      }
                      Return $Output
                  }

                  Function Set-DscConfiguration {
                      [CmdletBinding()]
                      param(
                          [Parameter(Mandatory = $true)][PSCredential]$AltAdminCredentials,
                          [Parameter(Mandatory = $true)][String]$AltAdminUserName,
                          [Parameter(Mandatory = $true)][PSCredential]$DaCredentials,
                          [Parameter(Mandatory = $true)][string]$DomainDNSName,
                          [Parameter(Mandatory = $true)][string]$DomainNetBIOSName,
                          [Parameter(Mandatory = $true)][string]$GatewayAddress,
                          [Parameter(Mandatory = $true)][string]$InstanceIP,
                          [Parameter(Mandatory = $true)][string]$InstanceNetBIOSName,
                          [Parameter(Mandatory = $true)][PSCredential]$LaCredentials,
                          [Parameter(Mandatory = $true)][string]$MacAddress,
                          [Parameter(Mandatory = $true)][PSCredential]$RestoreModeCredentials,
                          [Parameter(Mandatory = $true)][string]$SiteName,
                          [Parameter(Mandatory = $true)][string]$VPCCIDR
                      )

                      $VPCDNS = '169.254.169.253'

                      Write-Output 'Getting the DSC encryption thumbprint to secure the MOF file'
                      Try {
                          $DscCertThumbprint = Get-ChildItem -Path 'cert:\LocalMachine\My' -ErrorAction Stop | Where-Object { $_.Subject -eq 'CN=AWSQSDscEncryptCert' } | Select-Object -ExpandProperty 'Thumbprint'
                      } Catch [System.Exception] {
                          Write-Output "Failed to get DSC cert thumbprint $_"
                          Exit 1
                      }
                      
                      Write-Output 'Creating configuration data block that has the certificate information for DSC configuration processing'
                      $ConfigurationData = @{
                          AllNodes = @(
                              @{
                                  NodeName             = '*'
                                  CertificateFile      = 'C:\AWSQuickstart\publickeys\AWSQSDscPublicKey.cer'
                                  Thumbprint           = $DscCertThumbprint
                                  PSDscAllowDomainUser = $true
                              },
                              @{
                                  NodeName = 'localhost'
                              }
                          )
                      }
                      
                      Configuration ConfigInstance {
                          Import-DscResource -ModuleName 'PSDesiredStateConfiguration', 'NetworkingDsc', 'ComputerManagementDsc', 'DnsServerDsc', 'ActiveDirectoryDsc'
                          Node LocalHost {
                              NetAdapterName RenameNetAdapterPrimary {
                                  NewName    = 'Primary'
                                  MacAddress = $MacAddress
                              }
                              NetIPInterface DisableDhcp {
                                  Dhcp           = 'Disabled'
                                  InterfaceAlias = 'Primary'
                                  AddressFamily  = 'IPv4'
                                  DependsOn      = '[NetAdapterName]RenameNetAdapterPrimary'
                              }
                              IPAddress SetIP {
                                  IPAddress      = $InstanceIP
                                  InterfaceAlias = 'Primary'
                                  AddressFamily  = 'IPv4'
                                  DependsOn      = '[NetIPInterface]DisableDhcp'
                              }
                              DefaultGatewayAddress SetDefaultGateway {
                                  Address        = $GatewayAddress
                                  InterfaceAlias = 'Primary'
                                  AddressFamily  = 'IPv4'
                                  DependsOn      = '[IPAddress]SetIP'
                              }
                              DnsServerAddress DnsServerAddress {
                                  Address        = '127.0.0.1', '169.254.169.253'
                                  InterfaceAlias = 'Primary'
                                  AddressFamily  = 'IPv4'
                                  DependsOn      = '[DefaultGatewayAddress]SetDefaultGateway'
                              }
                              DnsConnectionSuffix DnsConnectionSuffix {
                                  InterfaceAlias                 = 'Primary'
                                  ConnectionSpecificSuffix       = $DomainDNSName
                                  RegisterThisConnectionsAddress = $True
                                  UseSuffixWhenRegistering       = $False
                                  DependsOn                      = '[DnsServerAddress]DnsServerAddress'
                              }
                              WindowsFeature DnsTools {
                                  Ensure    = 'Present'
                                  Name      = 'RSAT-DNS-Server'
                                  DependsOn = '[DnsConnectionSuffix]DnsConnectionSuffix'
                              }
                              WindowsFeature RSAT-AD-Tools {
                                  Ensure    = 'Present'
                                  Name      = 'RSAT-AD-Tools'
                                  DependsOn = '[WindowsFeature]DnsTools'
                              }
                              WindowsFeature RSAT-ADDS {
                                  Ensure    = 'Present'
                                  Name      = 'RSAT-ADDS'
                                  DependsOn = '[WindowsFeature]RSAT-AD-Tools'
                              }
                              WindowsFeature GPMC {
                                  Ensure    = 'Present'
                                  Name      = 'GPMC'
                                  DependsOn = '[WindowsFeature]RSAT-ADDS'
                              }
                              WindowsFeature DNS {
                                  Ensure    = 'Present'
                                  Name      = 'DNS'
                                  DependsOn = '[WindowsFeature]GPMC'
                              }
                              WindowsFeature AD-Domain-Services {
                                  Ensure    = 'Present'
                                  Name      = 'AD-Domain-Services'
                                  DependsOn = '[WindowsFeature]DNS'
                              }
                              Service ActiveDirectoryWebServices {
                                  Name        = 'ADWS'
                                  StartupType = 'Automatic'
                                  State       = 'Running'
                                  DependsOn   = '[WindowsFeature]AD-Domain-Services'
                              }
                              Computer Rename {
                                  Name      = $InstanceNetBIOSName
                                  DependsOn = '[WindowsFeature]AD-Domain-Services'
                              }
                              User AdministratorPassword {
                                  UserName  = 'Administrator'
                                  Password  = $LaCredentials
                                  DependsOn = '[Computer]Rename'
                              }
                              ADDomain PrimaryDC {
                                  DomainName                    = $DomainDnsName
                                  DomainNetBIOSName             = $DomainNetBIOSName
                                  Credential                    = $DaCredentials
                                  SafemodeAdministratorPassword = $RestoreModeCredentials
                                  DatabasePath                  = 'D:\NTDS'
                                  LogPath                       = 'D:\NTDS'
                                  SysvolPath                    = 'D:\SYSVOL'
                                  DependsOn                     = '[User]AdministratorPassword'
                              }
                              WaitForADDomain WaitForPrimaryDC {
                                  DomainName  = $DomainDnsName
                                  WaitTimeout = 600
                                  DependsOn   = '[ADDomain]PrimaryDC'
                              }
                              ADReplicationSite RegionSite {
                                  Name                       = $SiteName
                                  RenameDefaultFirstSiteName = $true
                                  DependsOn                  = '[WaitForADDomain]WaitForPrimaryDC', '[Service]ActiveDirectoryWebServices'
                              }
                              ADReplicationSubnet VPCCIDR {
                                  Name      = $VPCCIDR
                                  Site      = $SiteName
                                  DependsOn = '[ADReplicationSite]RegionSite'
                              }
                              ADUser AlternateAdminUser {
                                  Ensure                 = 'Present'
                                  DomainName             = $DomainDnsName
                                  UserName               = $AltAdminUserName
                                  Password               = $AltAdminCredentials
                                  DisplayName            = $AltAdminUserName
                                  PasswordAuthentication = 'Negotiate'
                                  UserPrincipalName      = "$AltAdminUserName@$DomainDnsName"
                                  Credential             = $DaCredentials
                                  DependsOn              = '[ADReplicationSite]RegionSite'
                              }
                              ADGroup AddAdminToDomainAdminsGroup {
                                  Ensure           = 'Present'
                                  GroupName        = 'Domain Admins'
                                  GroupScope       = 'Global'
                                  Category         = 'Security'
                                  MembersToInclude = @($AltAdminUserName, 'Administrator')
                                  Credential       = $DaCredentials
                                  DependsOn        = '[ADUser]AlternateAdminUser'
                              }
                              ADGroup AddAdminToEnterpriseAdminsGroup {
                                  Ensure           = 'Present'
                                  GroupName        = 'Enterprise Admins'
                                  GroupScope       = 'Universal'
                                  Category         = 'Security'
                                  MembersToInclude = @($AltAdminUserName, 'Administrator')
                                  Credential       = $DaCredentials
                                  DependsOn        = '[ADUser]AlternateAdminUser'
                              }
                              ADGroup AddAdminToSchemaAdminsGroup {
                                  Ensure           = 'Present'
                                  GroupName        = 'Schema Admins'
                                  GroupScope       = 'Universal'
                                  Category         = 'Security'
                                  MembersToExclude = @($AltAdminUserName, 'Administrator')
                                  Credential       = $DaCredentials
                                  DependsOn        = '[ADUser]AlternateAdminUser'
                              }
                              DnsServerForwarder ForwardtoVPCDNS {
                                  IsSingleInstance = 'Yes'
                                  IPAddresses      = $VPCDNS
                                  DependsOn        = '[WaitForADDomain]WaitForPrimaryDC'
                              }
                              ADOptionalFeature RecycleBin {
                                  FeatureName                       = 'Recycle Bin Feature'
                                  EnterpriseAdministratorCredential = $DaCredentials
                                  ForestFQDN                        = $DomainDnsName
                                  DependsOn                         = '[WaitForADDomain]WaitForPrimaryDC'
                              }
                              ADKDSKey KdsKey {
                                  Ensure                   = 'Present'
                                  EffectiveTime            = ((Get-Date).addhours(-10))
                                  AllowUnsafeEffectiveTime = $True
                                  DependsOn                = '[WaitForADDomain]WaitForPrimaryDC'
                              }
                          }
                      }
                      Write-Output 'Generating MOF file'
                      ConfigInstance -OutputPath 'C:\AWSQuickstart\ConfigInstance' -ConfigurationData $ConfigurationData
                  }

                  $UserPassword = ConvertTo-SecureString '{{AdminPassword}}' -AsPlainText -Force
                  $AltAdminCredentials = New-Object -TypeName 'System.Management.Automation.PSCredential' ('{{DomainDNSName}}\Admin', $UserPassword)
                  $DaCredentials = New-Object -TypeName 'System.Management.Automation.PSCredential' ('{{DomainDNSName}}\Administrator', $UserPassword)
                  $RestoreModeCredentials = New-Object -TypeName 'System.Management.Automation.PSCredential' ('Administrator', $UserPassword)
                  New-VolumeFromRawDisk
                  Invoke-PreConfig
                  Invoke-LcmConfig
                  $EniConfig = Get-EniConfig
                  Set-DscConfiguration -AltAdminCredentials $AltAdminCredentials -AltAdminUserName 'Admin' -DaCredentials $DaCredentials -DomainDNSName '{{DomainDNSName}}' -DomainNetBIOSName '{{DomainNetBIOSName}}' -GatewayAddress $EniConfig.GatewayAddress -InstanceIP $EniConfig.IpAddress -InstanceNetBIOSName '{{ADServer1NetBIOSName}}' -LaCredentials $RestoreModeCredentials -MacAddress $EniConfig.MacAddress -RestoreModeCredentials $RestoreModeCredentials -SiteName '{{global:REGION}}' -VPCCIDR '{{VPCCIDR}}'
              CloudWatchOutputConfig:
                CloudWatchOutputEnabled: true
                CloudWatchLogGroupName: !Sub /aws/Quick_Start/${AWS::StackName}
            nextStep: runDc1Mof
          - name: runDc1Mof
            action: aws:runCommand
            onFailure: step:signalfailure
            inputs:
              DocumentName: AWS-RunPowerShellScript
              InstanceIds:
                - "{{dc1InstanceId.InstanceId}}"
              Parameters:
                commands: |-
                  Function Invoke-DscStatusCheck {
                      $LCMState = Get-DscLocalConfigurationManager -ErrorAction SilentlyContinue | Select-Object -ExpandProperty 'LCMState'
                      If ($LCMState -eq 'PendingConfiguration' -Or $LCMState -eq 'PendingReboot') {
                          Exit 3010
                      } Else {
                          Write-Output 'DSC Config Completed'
                      }
                  }
                  Start-DscConfiguration 'C:\AWSQuickstart\ConfigInstance' -Wait -Verbose -Force
                  Invoke-DscStatusCheck
              CloudWatchOutputConfig:
                CloudWatchOutputEnabled: true
                CloudWatchLogGroupName: !Sub /aws/Quick_Start/${AWS::StackName}
            nextStep: DnsConfig
          - name: DnsConfig
            action: aws:runCommand
            onFailure: step:signalfailure
            inputs:
              DocumentName: AWS-RunPowerShellScript
              InstanceIds:
                - "{{dc1InstanceId.InstanceId}}"
              Parameters:
                commands: |-
                  Function Set-DnsDscConfiguration {
                      [CmdletBinding()]
                      param(
                          [Parameter(Mandatory = $true)][string]$ADServer1PrivateIP,
                          [Parameter(Mandatory = $true)][string]$MadDNSName, 
                          [Parameter(Mandatory = $true)][string]$MadDcIP01,
                          [Parameter(Mandatory = $true)][string]$MadDcIP02,
                          [Parameter(Mandatory = $false)][string]$VPCCIDR
                      )

                      $AClass = 0..8
                      $BClass = 9..16
                      $CClass = 17..24
                      $DClass = 25..32
                      $IP = $VPCCIDR.Split('/')[0]
                      [System.Collections.ArrayList]$IPArray = $IP -Split "\."
                      $Range = $VPCCIDR.Split('/')[1]
                      If ($AClass -contains $Range) {
                          [System.Array]$Number = $IPArray[0] 
                      } Elseif ($BClass -contains $Range) {
                          [System.Array]$Number = $IPArray[0, 1]
                      } Elseif ($CClass -contains $Range) {
                          [System.Array]$Number = $IPArray[0, 1, 2] 
                      } Elseif ($DClass -contains $Range) {
                          [System.Array]$Number = $IPArray[0, 1, 2, 3] 
                      } 
                      [System.Array]::Reverse($Number)
                      $IpRev = $Number -Join "."
                      $ZoneName = $IpRev + '.in-addr.arpa'

                      Write-Output 'Getting the DSC encryption thumbprint to secure the MOF file'
                      Try {
                          $DscCertThumbprint = Get-ChildItem -Path 'cert:\LocalMachine\My' -ErrorAction Stop | Where-Object { $_.Subject -eq 'CN=AWSQSDscEncryptCert' } | Select-Object -ExpandProperty 'Thumbprint'
                      } Catch [System.Exception] {
                          Write-Output "Failed to get DSC cert thumbprint $_"
                          Exit 1
                      }
                      
                      Write-Output 'Creating configuration data block that has the certificate information for DSC configuration processing'
                      $ConfigurationData = @{
                          AllNodes = @(
                              @{
                                  NodeName             = '*'
                                  CertificateFile      = 'C:\AWSQuickstart\publickeys\AWSQSDscPublicKey.cer'
                                  Thumbprint           = $DscCertThumbprint
                                  PSDscAllowDomainUser = $true
                              },
                              @{
                                  NodeName = 'localhost'
                              }
                          )
                      }
                      
                      Configuration ConfigInstance {
                          Import-DscResource -ModuleName 'PSDesiredStateConfiguration', 'NetworkingDsc', 'ComputerManagementDsc', 'DnsServerDsc', 'ActiveDirectoryDsc'
                          Node LocalHost {
                              DnsServerAddress DnsServerAddress {
                                  Address        = $ADServer1PrivateIP, '127.0.0.1'
                                  InterfaceAlias = 'Primary'
                                  AddressFamily  = 'IPv4'
                              }
                              DnsConnectionSuffix DnsConnectionSuffix {
                                  InterfaceAlias                 = 'Primary'
                                  ConnectionSpecificSuffix       = (Get-ADDomain | Select-Object -ExpandProperty 'DNSRoot')
                                  RegisterThisConnectionsAddress = $True
                                  UseSuffixWhenRegistering       = $False
                                  DependsOn                      = '[DnsServerAddress]DnsServerAddress'
                              }
                              DnsServerConditionalForwarder 'MADForwarder' {
                                  Name             = $MadDNSName 
                                  MasterServers    = @($MadDcIP01, $MadDcIP02)
                                  ReplicationScope = 'Forest'
                                  Ensure           = 'Present'
                              }
                              DnsServerADZone CreateReverseLookupZone {
                                  Ensure           = 'Present'
                                  Name             = $ZoneName
                                  DynamicUpdate    = 'Secure'
                                  ReplicationScope = 'Forest'
                                  DependsOn        = '[DnsConnectionSuffix]DnsConnectionSuffix'
                              }
                              DnsServerScavenging SetServerScavenging {
                                  DnsServer          = 'localhost'
                                  ScavengingState    = $true
                                  ScavengingInterval = '7.00:00:00'
                                  RefreshInterval    = '7.00:00:00'
                                  NoRefreshInterval  = '7.00:00:00'
                                  DependsOn          = '[DnsServerADZone]CreateReverseLookupZone'
                              }
                          }
                      }
                      Write-Output 'Generating MOF file'
                      ConfigInstance -OutputPath 'C:\AWSQuickstart\ConfigInstance' -ConfigurationData $ConfigurationData
                  }

                  Function Invoke-Cleanup {
                      [CmdletBinding()]
                      Param (
                          [Parameter(Mandatory = $true)][String]$VPCCIDR
                      )

                      Write-Output 'Setting Windows Firewall WinRM Public rule to allow VPC CIDR traffic'
                      Try {
                          Set-NetFirewallRule -Name 'WINRM-HTTP-In-TCP-PUBLIC' -RemoteAddress $VPCCIDR
                      } Catch [System.Exception] {
                          Write-Output "Failed allow WinRM Traffic from VPC CIDR $_"
                      }

                      Write-Output 'Removing DSC Configuration'
                      Try {    
                          Remove-DscConfigurationDocument -Stage 'Current' -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed build DSC Configuration $_"
                      }

                      Write-Output 'Re-enabling Windows Firewall'
                      Try {
                          Get-NetFirewallProfile -ErrorAction Stop | Set-NetFirewallProfile -Enabled 'True' -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed re-enable firewall $_"
                      }

                      Write-Output 'Removing QuickStart build files'
                      Try {
                          Remove-Item -Path 'C:\AWSQuickstart' -Recurse -Force -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed remove QuickStart build files $_"
                      }

                      Write-Output 'Removing self signed cert'
                      Try {
                          $SelfSignedThumb = Get-ChildItem -Path 'cert:\LocalMachine\My\' -ErrorAction Stop | Where-Object { $_.Subject -eq 'CN=AWSQSDscEncryptCert' } | Select-Object -ExpandProperty 'Thumbprint'
                          Remove-Item -Path "cert:\LocalMachine\My\$SelfSignedThumb" -DeleteKey -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed remove self signed cert $_"
                      }
                  }

                  Function Get-EniConfig {
                      Write-Output 'Getting network configuration'
                      Try {
                          $NetIpConfig = Get-NetIPConfiguration -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to get network configuration $_"
                          Exit 1
                      }

                      Write-Output 'Grabbing the current gateway address in order to static IP correctly'
                      $GatewayAddress = $NetIpConfig | Select-Object -ExpandProperty 'IPv4DefaultGateway' | Select-Object -ExpandProperty 'NextHop'

                      Write-Output 'Formatting IP address in format needed for IPAdress DSC resource'
                      $IpAddress = $NetIpConfig | Select-Object -ExpandProperty 'IPv4Address' | Select-Object -ExpandProperty 'IpAddress'
                      $Prefix = $NetIpConfig | Select-Object -ExpandProperty 'IPv4Address' | Select-Object -ExpandProperty 'PrefixLength'
                      $IpAddr = 'IP/CIDR' -replace 'IP', $IpAddress -replace 'CIDR', $Prefix

                      Write-Output 'Getting MAC address'
                      Try {
                          $MacAddress = Get-NetAdapter -ErrorAction Stop | Select-Object -ExpandProperty 'MacAddress'
                      } Catch [System.Exception] {
                          Write-Output "Failed to get MAC address $_"
                          Exit 1
                      }

                      $Output = [PSCustomObject][Ordered]@{
                          'GatewayAddress' = $GatewayAddress
                          'IpAddress'      = $IpAddr
                          'DnsIpAddress'   = $IpAddress
                          'MacAddress'     = $MacAddress
                      }
                      Return $Output
                  }

                  $EniConfig = Get-EniConfig
                  Set-DnsDscConfiguration -ADServer1PrivateIP $EniConfig.DnsIpAddress -VPCCIDR '{{VPCCIDR}}' -MadDcIP01 '{{MadDcIP01}}' -MadDcIP02 '{{MadDcIP02}}' -MadDNSName '{{MadDNSName}}'
                  Start-DscConfiguration 'C:\AWSQuickstart\ConfigInstance' -Wait -Verbose -Force
                  Invoke-Cleanup -VPCCIDR '{{VPCCIDR}}'
              CloudWatchOutputConfig:
                CloudWatchOutputEnabled: true
                CloudWatchLogGroupName: !Sub /aws/Quick_Start/${AWS::StackName}
            nextStep: TrustConfig
          - name: TrustConfig
            action: aws:runCommand
            onFailure: step:signalfailure
            inputs:
              DocumentName: AWS-RunPowerShellScript
              InstanceIds:
                - "{{dc1InstanceId.InstanceId}}"
              Parameters:
                commands: |-
                  Function Get-EniConfig {
                      Write-Output 'Getting network configuration'
                      Try {
                          $NetIpConfig = Get-NetIPConfiguration -ErrorAction Stop
                      } Catch [System.Exception] {
                          Write-Output "Failed to get network configuration $_"
                          Exit 1
                      }

                      Write-Output 'Grabbing the current gateway address in order to static IP correctly'
                      $GatewayAddress = $NetIpConfig | Select-Object -ExpandProperty 'IPv4DefaultGateway' | Select-Object -ExpandProperty 'NextHop'

                      Write-Output 'Formatting IP address in format needed for IPAdress DSC resource'
                      $IpAddress = $NetIpConfig | Select-Object -ExpandProperty 'IPv4Address' | Select-Object -ExpandProperty 'IpAddress'
                      $Prefix = $NetIpConfig | Select-Object -ExpandProperty 'IPv4Address' | Select-Object -ExpandProperty 'PrefixLength'
                      $IpAddr = 'IP/CIDR' -replace 'IP', $IpAddress -replace 'CIDR', $Prefix

                      Write-Output 'Getting MAC address'
                      Try {
                          $MacAddress = Get-NetAdapter -ErrorAction Stop | Select-Object -ExpandProperty 'MacAddress'
                      } Catch [System.Exception] {
                          Write-Output "Failed to get MAC address $_"
                          Exit 1
                      }

                      $Output = [PSCustomObject][Ordered]@{
                          'GatewayAddress' = $GatewayAddress
                          'IpAddress'      = $IpAddr
                          'DnsIpAddress'   = $IpAddress
                          'MacAddress'     = $MacAddress
                      }
                      Return $Output
                  }

                  Function Invoke-TrustAction {
                      [CmdletBinding()]
                      Param(
                          [parameter(Mandatory = $true)][String]$RemoteFQDN,
                          [parameter(Mandatory = $false)][String]$TrustPassword
                      )

                      $LocalForestOrDomain = [System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest() 
                      $AdTrustDir = [System.DirectoryServices.ActiveDirectory.TrustDirection]::Bidirectional
                      $Null = Clear-DnsServerCache -Force -ErrorAction SilentlyContinue
                      $Null = Clear-DnsClientCache -ErrorAction SilentlyContinue
                      $LocalForestOrDomain.CreateLocalSideOfTrustRelationship($RemoteFQDN, $AdTrustDir, $TrustPassword)
                      & ksetup.exe /SetEncTypeAttr $RemoteFQDN 'RC4-HMAC-MD5' 'AES128-CTS-HMAC-SHA1-96' 'AES256-CTS-HMAC-SHA1-96'
                  }

                  $TrustPassword = '{{AdminPassword}}'

                  $EniConfig = Get-EniConfig
                  Write-Output 'Creating Onprem side of trust.'
                  Invoke-TrustAction -RemoteFQDN '{{MadDNSName}}' -TrustPassword $TrustPassword

                  $CidrRange = @{ IpProtocol = "-1"; IpRanges = '0.0.0.0/0' }
                  Write-Output 'Modifying the AWS Managed Microsoft Active Directory Security Group.'
                  Try {
                      $SecurityGroupId = Get-EC2SecurityGroup -Filter @{ Name = 'group-name'; Values = "{{MadDirectoryID}}_controllers" } -ErrorAction Stop | Select-Object -Property 'GroupId' -ExpandProperty 'GroupId'
                      Grant-EC2SecurityGroupEgress -GroupId $SecurityGroupId -IpPermission $CidrRange -Region $Region -ErrorAction Stop
                  } Catch [System.Exception] {
                      Write-Output "Failed to get or modify the AWS Managed Microsoft Active Directory Security Group. $_"
                      Exit 1
                  }

                  $TrustTypeForest = New-Object -TypeName 'Amazon.DirectoryService.TrustType' -ArgumentList 'Forest'
                  $TrustDirTwoWay = New-Object -TypeName 'Amazon.DirectoryService.TrustDirection' -ArgumentList 'Two-Way'
                  $SelectiveAuthDis = New-Object -TypeName 'Amazon.DirectoryService.SelectiveAuth' -ArgumentList 'Disabled'
                  Write-Output 'Creating trust between MAD and Onprem.'
                  Try {
                      New-DSTrust -DirectoryId '{{MadDirectoryID}}' -ConditionalForwarderIpAddr $EniConfig.DnsIpAddress -RemoteDomainName '{{DomainDNSName}}' -SelectiveAuth $SelectiveAuthDis -TrustDirection $TrustDirTwoWay -TrustType $TrustTypeForest -TrustPassword $TrustPassword
                  } Catch [System.Exception] {
                      Write-Output "Failed to create trust between MAD and Onprem. $_"
                      Exit 1
                  }
              CloudWatchOutputConfig:
                CloudWatchOutputEnabled: true
                CloudWatchLogGroupName: !Sub /aws/Quick_Start/${AWS::StackName}
          - name: CFNSignalEnd
            action: aws:branch
            inputs:
              Choices:
                - NextStep: signalsuccess
                  Not:
                    Variable: "{{StackName}}"
                    StringEquals: ""
                - NextStep: sleepend
                  Variable: "{{StackName}}"
                  StringEquals: ""
          - name: signalsuccess
            action: aws:executeAwsApi
            isEnd: true
            inputs:
              Service: cloudformation
              Api: SignalResource
              LogicalResourceId: OnPremDomainController
              StackName: "{{StackName}}"
              Status: SUCCESS
              UniqueId: "{{dc1InstanceId.InstanceId}}"
          - name: sleepend
            action: aws:sleep
            isEnd: true
            inputs:
              Duration: PT1S
          - name: signalfailure
            action: aws:executeAwsApi
            inputs:
              Service: cloudformation
              Api: SignalResource
              LogicalResourceId: OnPremDomainController
              StackName: "{{StackName}}"
              Status: FAILURE
              UniqueId: "{{dc1InstanceId.InstanceId}}"
      DocumentType: Automation
      Tags:
        - Key: StackName
          Value:
            Ref: AWS::StackName
  OnPremDomainControllerSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Domain Controllers Security Group
      SecurityGroupIngress:
        - Description: DNS
          FromPort: 53
          IpProtocol: tcp
          CidrIp: 10.0.0.0/24
          ToPort: 53
        - Description: DNS
          FromPort: 53
          IpProtocol: udp
          CidrIp: 10.0.0.0/24
          ToPort: 53
        - Description: Kerberos
          FromPort: 88
          IpProtocol: tcp
          CidrIp: 10.0.0.0/24
          ToPort: 88
        - Description: Kerberos
          FromPort: 88
          IpProtocol: udp
          CidrIp: 10.0.0.0/24
          ToPort: 88
        - Description: Windows Time
          FromPort: 123
          IpProtocol: udp
          CidrIp: 10.0.0.0/24
          ToPort: 123
        - Description: RPC Port
          FromPort: 135
          IpProtocol: tcp
          CidrIp: 10.0.0.0/24
          ToPort: 135
        - Description: Netlogon
          FromPort: 138
          IpProtocol: udp
          CidrIp: 10.0.0.0/24
          ToPort: 138
        - Description: LDAP
          FromPort: 389
          IpProtocol: tcp
          CidrIp: 10.0.0.0/24
          ToPort: 389
        - Description: LDAP
          FromPort: 389
          IpProtocol: udp
          CidrIp: 10.0.0.0/24
          ToPort: 389
        - Description: SMB
          FromPort: 445
          IpProtocol: tcp
          CidrIp: 10.0.0.0/24
          ToPort: 445
        - Description: SMB
          FromPort: 445
          IpProtocol: udp
          CidrIp: 10.0.0.0/24
          ToPort: 445
        - Description: Kerberos Set & Change Password
          FromPort: 464
          IpProtocol: udp
          CidrIp: 10.0.0.0/24
          ToPort: 464
        - Description: Kerberos Set & Change Password
          FromPort: 464
          IpProtocol: tcp
          CidrIp: 10.0.0.0/24
          ToPort: 464
        - Description: LDAP over SSL
          FromPort: 636
          IpProtocol: tcp
          CidrIp: 10.0.0.0/24
          ToPort: 636
        - Description: LDAP Global Catalog
          FromPort: 3268
          IpProtocol: tcp
          CidrIp: 10.0.0.0/24
          ToPort: 3268
        - Description: LDAP Global Catalog over SSL
          FromPort: 3269
          IpProtocol: tcp
          CidrIp: 10.0.0.0/24
          ToPort: 3269
        - Description: RDP Access
          FromPort: 3389
          IpProtocol: tcp
          CidrIp: !Ref RdpCIDR
          ToPort: 3389
        - Description: WinRM
          FromPort: 5985
          IpProtocol: tcp
          CidrIp: 10.0.0.0/24
          ToPort: 5985
        - Description: SOAP ADWS
          FromPort: 9389
          IpProtocol: tcp
          CidrIp: 10.0.0.0/24
          ToPort: 9389
        - Description: Random RPC
          FromPort: 49152
          IpProtocol: tcp
          CidrIp: 10.0.0.0/24
          ToPort: 65535
        - Description: Random RPC
          FromPort: 49152
          IpProtocol: udp
          CidrIp: 10.0.0.0/24
          ToPort: 65535
      Tags:
        - Key: Name
          Value: DomainControllersSecurityGroup
      VpcId: !Ref VPC
  OnPremDomainController:
    Type: AWS::EC2::Instance
    DependsOn: ManagedAD
    CreationPolicy:
      ResourceSignal:
        Count: 1
        Timeout: PT60M
    Properties:
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            DeleteOnTermination: true
            Encrypted: true
            KmsKeyId: alias/aws/ebs
            VolumeSize: 60
            VolumeType: gp3
        - DeviceName: /dev/xvdf
          Ebs:
            DeleteOnTermination: true
            Encrypted: true
            KmsKeyId: alias/aws/ebs
            VolumeSize: 10
            VolumeType: gp3
      IamInstanceProfile: !Ref InstanceProfile
      ImageId: !Ref AMI
      InstanceType: t3.large
      KeyName: ee-default-keypair
      SecurityGroupIds:
        - Ref: OnPremDomainControllerSG
      SubnetId: !Ref VPCPublicSubnet1Subnet
      Tags:
        - Key: Domain
          Value: !Ref OnpremDomainName
        - Key: Name
          Value: ONPREM-DC01
      UserData:
        Fn::Base64:
          Fn::Sub:
            - |
              <powershell>
              $Params = @{
                  AdminPassword         = '${AdminPassword}'
                  ADServer1NetBIOSName  = 'ONPREM-DC01'
                  DomainDNSName         = '${DomainDNSName}'
                  DomainNetBIOSName     = '${DomainNetBIOSName}'
                  MadDcIP01             = '${MadDcIP01}'
                  MadDcIP02             = '${MadDcIP02}'
                  MadDirectoryID        = '${MadDirectoryID}'
                  MadDNSName            = '${MadDNSName}'
                  StackName             = '${AWS::StackName}'
                  URLSuffix             = '${AWS::URLSuffix}'
                  VPCCIDR               = '${VPCCIDR}'
              }
              Start-SSMAutomationExecution -DocumentName '${OnPremDomainControllerSsmAuto}' -Parameter $Params
              </powershell>
            - AdminPassword: !Ref AdminPassword
              DomainDNSName: !Ref OnpremDomainName
              DomainNetBIOSName: !Ref OnpremNetBIOSName
              MadDcIP01: !Select [0, !GetAtt ManagedAD.DnsIpAddresses]
              MadDcIP02: !Select [1, !GetAtt ManagedAD.DnsIpAddresses]
              MadDirectoryID: !Ref ManagedAD
              MadDNSName: !Ref MADDomainName
              VPCCIDR: !GetAtt VPC.CidrBlock
  OnPremDomainControllerIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: "-1"
      Description: Security Group Rule between Domain Controllers
      FromPort: -1
      GroupId:
        Ref: OnPremDomainControllerSG
      SourceSecurityGroupId:
        Ref: OnPremDomainControllerSG
      ToPort: -1
  RdsDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Demo-DBSubnetGroup
      DBSubnetGroupName: Demo-DBSubnetGroup
      SubnetIds:
        - !Ref VPCPublicSubnet1Subnet
        - !Ref VPCPublicSubnet2Subnet
  RdsDB:
    Type: AWS::RDS::DBInstance
    DependsOn: ManagedAD
    Properties:
      AllocatedStorage: 20
      AvailabilityZone: !Select
        - 0
        - Fn::GetAZs: !Ref AWS::Region
      DBInstanceClass: db.t3.xlarge
      DBInstanceIdentifier: Demo
      DBSubnetGroupName: !Ref RdsDBSubnetGroup
      Domain: !Ref ManagedAD
      DomainIAMRoleName: !Ref RDSRole
      Engine: sqlserver-se
      EngineVersion: 15.00.4073.23.v1
      LicenseModel: license-included
      MasterUsername: admin
      MasterUserPassword: !Ref RDSPassword
      StorageType: gp2
      VPCSecurityGroups:
        - !Ref DomainMemberSG